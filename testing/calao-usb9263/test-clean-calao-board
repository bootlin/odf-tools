# Minicom script to test and clean up Calao bor for kernel training
# Some path have to be changed according your set up
# Host IP adfress is supossed to be 192.168.100.1
# nfsroot is located at /mnt/open/felabs/linux/modules/nfsroot/
# extracted from http://free-electrons.com/labs/labs.tar.xz
# The kernel image to use is uImage_K_train

# Run this script with
# minicom -S <script-name>

# Need to send a newline
# in case 'bootdelay' is set to a non-zero value and 'bootcmd'
# is defined (autoboot mode)

send ""
gosub ubootprompt

print "### Erasing U-boot environment and NAND flash... ###"

# Erase the U-boot environment, by writing junk to it
# causing an invalid CRC, and forcing the default
# one to be reloaded
# This allows to deal with boards with an invalid ethaddr

send "cp.b 21000000 C0002000 2000"
gosub ubootprompt

# Erase NAND to make sure that there is nothing remaining 
# Otherwise, the board may be able to boot a kernel in NAND flash

send "nand erase"
gosub ubootprompt

send "reset"
gosub ubootprompt

# Need to send a newline here for the same autoboot reasons

print "### Preparing environment to load and boot a Linux kernel... ###"

send ""

send "set ethaddr 00:00:00:11:22:33"
gosub ubootprompt

send "set serverip 192.168.100.1"
gosub ubootprompt

send "set ipaddr 192.168.100.100"
gosub ubootprompt

send "set bootargs root=/dev/nfs console=ttyS0 ip=192.168.100.100 nfsroot=192.168.100.1:/mnt/open/felabs/linux/modules/nfsroot/"
gosub ubootprompt

send "set bootdelay 0"
gosub ubootprompt

send "set autostart yes"
gosub ubootprompt

send "set bootcmd"
gosub ubootprompt

send "saveenv"
gosub ubootprompt

# Reset required after the changes to ethaddr

print "Trying to load and boot a Linux kernel..."

send "reset"
gosub ubootprompt

send "tftp 0x21000000 uImage_K_train
expect {
	"Please press Enter to activate this console."
}

send ""
expect {
	"# "
}

send "reboot"
gosub ubootprompt

print "### All tests run successfully - Board ready to use ###"

exit

ubootprompt:
expect {
	"U-Boot> "
}
return
